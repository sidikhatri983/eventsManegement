<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Event Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/21.6.3/i18next.min.js"></script>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-body-tertiary border-bottom">
    <div class="container">
        <a class="navbar-brand translate-btn" href="/events" id="navTitle">Event Management</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link text-dark translate-btn" href="/events" id="homeLink">Home</a></li>
                <li class="nav-item"><a class="nav-link text-dark translate-btn" href="/contact" id="contactLink">Contact</a></li>
            </ul>
            <ul class="navbar-nav me-3" sec:authorize="isAuthenticated()">
                <li class="nav-item dropdown">
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/profile" id="profileLink">Profile</a></li>
                        <li><a class="dropdown-item translate-btn" href="/" id="homeNavLink">Home</a></li>
                        <li class="nav-item" sec:authorize="hasAuthority('ROLE_ADMIN')">
                            <a class="nav-link" href="/admin/users" id="adminLink">Admin</a>
                        </li>

                    </ul>
                </li>
            </ul>
            <form sec:authorize="isAuthenticated()" method="post" action="/logout">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <button type="submit" class="btn btn-danger translate-btn" id="logoutBtn">Logout</button>
            </form>
            <ul class="navbar-nav" sec:authorize="!isAuthenticated()">
                <li class="nav-item"><a href="/register" class="btn btn-outline-primary me-2 translate-btn" id="registerBtn">Register</a></li>
                <li class="nav-item"><a href="/login" class="btn btn-primary translate-btn" id="loginBtn">Login</a></li>
            </ul>
            <!-- Language Switcher as Select -->
            <div class="navbar-nav ms-3">
                <select id="langSelect" class="form-select">
                    <option value="en">English</option>
                    <option value="fr">Français</option>
                    <option value="ar">عربي</option>
                </select>
            </div>
        </div>
    </div>
</nav>

<div class="container py-5" sec:authorize="isAuthenticated()">
    <div class="container mt-4">
        <h2 class="translate-btn" id="searchTitle">Search Events Worldwide</h2>
        <form method="get" action="/search" class="mb-4">
            <div class="input-group">
                <input type="text" name="city" class="form-control" placeholder="Enter City or Location" required id="cityInput">
                <button type="submit" class="btn btn-primary translate-btn" id="searchBtn">Search</button>
            </div>
        </form>
    </div>
    <h1 class="text-center mb-4 translate-btn" id="eventManagementTitle">Event Management</h1>

    <!-- Event Table -->
    <table class="table table-bordered table-hover">
        <thead class="table-dark">
        <tr>
            <th class="translate-btn" id="titleHeader">Title</th>
            <th class="translate-btn" id="descriptionHeader">Description</th>
            <th class="translate-btn" id="startDateHeader">DateStart</th>
            <th class="translate-btn" id="endDateHeader">DateEnd</th>
            <th class="translate-btn" id="locationHeader">Location</th>
            <th class="translate-btn" id="actionsHeader">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="event : ${events}">
            <td th:text="${event.title}"></td>
            <td th:text="${event.description}"></td>
            <td th:text="${event.dateStart}"></td>
            <td th:text="${event.dateEnd}"></td>
            <td>
              <span th:if="${event.locationType == 'online'}">
                <a th:href="${event.meetingLink}" th:text="${event.meetingLink}" target="_blank"></a>
              </span>
                <span th:if="${event.locationType == 'present'}">
                  <span th:text="${event.gpsLocation}"></span>
                </span>
            </td>

            <td>
                <a th:href="@{'/events/delete/' + ${event.id}}" class="btn btn-danger btn-sm mb-2 translate-btn" id="deleteBtn" onclick="return confirm('Are you sure you want to delete this event?')">Delete</a>
                <a th:href="@{'/events/edit/' + ${event.id}}" class="btn btn-warning btn-sm translate-btn" id="editBtn">Edit</a>
                <a th:href="@{'/events/invite/' + ${event.id}}" class="btn btn-primary btn-sm translate-btn" id="inviteBtn">Invite</a>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- Add Event Form -->
    <h2 class="mt-5 translate-btn" id="addEventTitle">Add New Event</h2>
    <form method="post" action="/events/add">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <div class="mb-3">
            <label class="form-label translate-btn" id="eventTitleLabel">Event Title</label>
            <input type="text" name="title" class="form-control" required />
        </div>
        <div class="mb-3">
            <label class="form-label translate-btn" id="eventDescLabel">Event Description</label>
            <textarea name="description" class="form-control" required></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label translate-btn" id="eventStartDateLabel">Event Date Start</label>
            <input type="datetime-local" name="date" value="2025-03-21T12:00" id="dateStart" class="form-control" required />
        </div>
        <div class="mb-3">
            <label class="form-label translate-btn" id="eventEndDateLabel">Event Date End</label>
            <input type="datetime-local" name="dateEnd" value="2026-03-21T12:00" id="dateEnd" class="form-control" required min="{{today}}">

        </div>
        <div class="mb-3">
            <label class="form-label translate-btn" id="eventLocationLabel">Event City</label>
            <input type="text" name="location" class="form-control" required />
        </div>
        <!-- Location Type -->
        <label id="label-location-type">Location Type:</label>
        <select name="locationType" id="locationType" onchange="toggleLocationFields()" required>
            <option value="" disabled selected id="option-choose">Choose</option>
            <option value="online" id="option-online">Online</option>
            <option value="present" id="option-present">Present</option>
        </select><br/>

        <!-- Meeting Link (Online only) -->
        <div id="meetingLinkDiv" style="display: none;">
            <label id="label-meeting-link">Meeting Link:</label>
            <input type="url" name="meetingLink" placeholder="https://..." />
        </div>

        <!-- GPS Location (Present only) -->
        <div id="gpsDiv" style="display: none;">
            <label id="label-gps-coordinates">GPS Coordinates:</label>
            <input type="text" name="gpsLocation" placeholder="e.g. 37.7749,-122.4194" />
        </div>

        <label for="visibility" id="label-visibility">Visibility:</label>
        <select id="visibility" name="visibility" class="form-control">
            <option value="PUBLIC" id="option-public">Public</option>
            <option value="PRIVATE" id="option-private">Private</option>
        </select>


        <button type="submit" class="btn btn-success translate-btn" id="addEventBtn">Add Event</button>
    </form>
</div>

<div class="container mt-5" sec:authorize="!isAuthenticated()">
    <h1 class="translate-btn" id="protectedContentTitle">Protected Page Content</h1>
    <p class="translate-btn" id="protectedContentText">This content is only accessible after login.</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function toggleLocationFields() {
        var type = document.getElementById("locationType").value;
        document.getElementById("meetingLinkDiv").style.display = type === 'online' ? 'block' : 'none';
        document.getElementById("gpsDiv").style.display = type === 'present' ? 'block' : 'none';
    }

    // Call it on page load if editing an existing event
    window.onload = toggleLocationFields;
</script>

<script>
    document.querySelector('form[action="/events/add"]').addEventListener('submit', function (e) {
        const startInput = document.getElementById('dateStart');
        const endInput = document.getElementById('dateEnd');

        const startDate = new Date(startInput.value);
        const endDate = new Date(endInput.value);
        const now = new Date();

        if (startDate >= endDate) {
            alert("Start date must be before end date.");
            e.preventDefault();
            return;
        }

        if (endDate <= now) {
            alert("End date must be in the future.");
            e.preventDefault();
            return;
        }
    });
</script>

<script>
    // i18next initialization
    i18next.init({
        lng: localStorage.getItem('lang') || 'en',
        resources: {
            en: {
                translation: {
                    "navTitle": "Event Management",
                    "homeLink": "Home",
                    "contactLink": "Contact",
                    "searchTitle": "Search Events Worldwide",
                    "eventManagementTitle": "Event Management",
                    "titleHeader": "Title",
                    "descriptionHeader": "Description",
                    "startDateHeader": "DateStart",
                    "endDateHeader": "DateEnd",
                    "locationHeader": "Location",
                    "actionsHeader": "Actions",
                    "addEventTitle": "Add New Event",
                    "eventTitleLabel": "Event Title",
                    "searchBtn": "Search",
                    "eventDescLabel": "Event Description",
                    "eventStartDateLabel": "Event Date Start",
                    "eventEndDateLabel": "Event Date End",
                    "eventLocationLabel": "Event Location",
                    "protectedContentTitle": "Protected Page Content",
                    "protectedContentText": "This content is only accessible after login.",
                    "deleteBtn": "Delete",
                    "editBtn": "Edit",
                    "inviteBtn": "Invite",
                    "addEventBtn": "Add Event",
                    "registerBtn": "Register",
                    "loginBtn": "Login",
                    "logoutBtn": "Logout",
                    "label-location-type": "Location Type:",
                    "option-choose": "Choose",
                    "option-online": "Online",
                    "option-present": "Present",
                    "label-meeting-link": "Meeting Link:",
                    "label-gps-coordinates": "GPS Coordinates:",
                    "label-visibility": "Visibility:",
                    "option-public": "Public",
                    "option-private": "Private",
                    "cityInputPlaceholder": "Enter City or Location"
                }
            },
            fr: {
                translation: {
                    "navTitle": "Gestion d'événements",
                    "homeLink": "Accueil",
                    "contactLink": "Contact",
                    "searchTitle": "Rechercher des événements",
                    "eventManagementTitle": "Gestion d'événements",
                    "titleHeader": "Titre",
                    "descriptionHeader": "Description",
                    "startDateHeader": "Date de début",
                    "endDateHeader": "Date de fin",
                    "locationHeader": "Emplacement",
                    "actionsHeader": "Actions",
                    "searchBtn": "Rechercher",
                    "addEventTitle": "Ajouter un événement",
                    "eventTitleLabel": "Titre de l'événement",
                    "eventDescLabel": "Description",
                    "eventStartDateLabel": "Date de début",
                    "eventEndDateLabel": "Date de fin",
                    "eventLocationLabel": "Lieu",
                    "protectedContentTitle": "Contenu protégé",
                    "protectedContentText": "Contenu accessible après connexion.",
                    "deleteBtn": "Supprimer",
                    "editBtn": "Modifier",
                    "inviteBtn": "Inviter",
                    "addEventBtn": "Ajouter",
                    "registerBtn": "S'inscrire",
                    "loginBtn": "Connexion",
                    "logoutBtn": "Déconnexion",
                    "label-location-type": "Type de lieu :",
                    "option-choose": "Choisir",
                    "option-online": "En ligne",
                    "option-present": "Présentiel",
                    "label-meeting-link": "Lien de réunion :",
                    "label-gps-coordinates": "Coordonnées GPS :",
                    "label-visibility": "Visibilité :",
                    "option-public": "Public",
                    "option-private": "Privé",
                    "cityInputPlaceholder": "Entrez une ville ou un lieu"
                }
            },
            ar: {
                translation: {
                    "navTitle": "إدارة الفعاليات",
                    "homeLink": "الرئيسية",
                    "contactLink": "اتصل بنا",
                    "searchTitle": "بحث الفعاليات",
                    "eventManagementTitle": "إدارة الفعاليات",
                    "titleHeader": "العنوان",
                    "descriptionHeader": "الوصف",
                    "startDateHeader": "تاريخ البداية",
                    "endDateHeader": "تاريخ النهاية",
                    "locationHeader": "الموقع",
                    "actionsHeader": "إجراءات",
                    "searchBtn": "بحث",
                    "addEventTitle": "إضافة فعالية",
                    "eventTitleLabel": "عنوان الفعالية",
                    "eventDescLabel": "الوصف",
                    "eventStartDateLabel": "تاريخ البدء",
                    "eventEndDateLabel": "تاريخ الانتهاء",
                    "eventLocationLabel": "المكان",
                    "protectedContentTitle": "محتوى محمي",
                    "protectedContentText": "هذا المحتوى متاح بعد التسجيل.",
                    "deleteBtn": "حذف",
                    "editBtn": "تعديل",
                    "inviteBtn": "دعوة",
                    "addEventBtn": "إضافة",
                    "registerBtn": "تسجيل",
                    "loginBtn": "تسجيل الدخول",
                    "logoutBtn": "تسجيل الخروج",
                    "label-location-type": "نوع الموقع:",
                    "option-choose": "اختر",
                    "option-online": "عبر الإنترنت",
                    "option-present": "حضوري",
                    "label-meeting-link": "رابط الاجتماع:",
                    "label-gps-coordinates": "إحداثيات:",
                    "label-visibility": "الرؤية:",
                    "option-public": "عام",
                    "option-private": "خاص",
                    "cityInputPlaceholder": "أدخل المدينة أو الموقع"
                }
            }
        }
    }, function(err, t) {
        // Update all translations
        updateTranslations();

        // Set initial language selection
        document.getElementById('langSelect').value = localStorage.getItem('lang') || 'en';

        // Language switch handler
        document.getElementById('langSelect').addEventListener('change', function(event) {
            i18next.changeLanguage(event.target.value);
            localStorage.setItem('lang', event.target.value);
            updateTranslations();
        });
    });

    function updateTranslations() {
        // Update all elements with translate-btn class
        document.querySelectorAll('.translate-btn').forEach(function(elem) {
            if (elem.id) {
                elem.textContent = i18next.t(elem.id);
            }
        });

        // Update form placeholders
        document.getElementById('cityInput').placeholder = i18next.t('cityInputPlaceholder');

        // Update labels and options that aren't using translate-btn class
        const elementsToTranslate = [
            {id: 'label-location-type', prop: 'textContent'},
            {id: 'option-choose', prop: 'textContent'},
            {id: 'option-online', prop: 'textContent'},
            {id: 'option-present', prop: 'textContent'},
            {id: 'label-meeting-link', prop: 'textContent'},
            {id: 'label-gps-coordinates', prop: 'textContent'},
            {id: 'label-visibility', prop: 'textContent'},
            {id: 'option-public', prop: 'textContent'},
            {id: 'option-private', prop: 'textContent'}
        ];

        elementsToTranslate.forEach(item => {
            const element = document.getElementById(item.id);
            if (element) {
                element[item.prop] = i18next.t(item.id);
            }
        });
    }
</script>
</body>
</html>
